<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
	<link rel="stylesheet" href="styles.css">
	<title>PMD Text Line Test</title>
	
	<link rel="icon" 
      type="image/png" 
      href="assets/favicon.png" />
	  
	<meta charset="utf-8"/>
	<meta name="description" content="Test Lines of text"/>
	<meta name="author" content="u/TheDasK" />
	<meta name="robots" content="index,nofollow" />
	  
</head>
<body>
	<h1>ExplorerScript Boundary Test</h1>
	<div class="section-input">
		<textarea rows="4" cols="56" id="input" onkeyup="inputChange()"></textarea>
	</div>
	<div class="section-result ">
		<canvas width="480" height="88" id="box"></canvas>
		<p id="output"></p>
	</div>
	<div class="section-text">
		<p>Scale: <a onclick="scaleChange(1)">1x</a> <a onclick="scaleChange(2)">2x</a> <a onclick="scaleChange(3)">3x</a> <a onclick="scaleChange(4)">4x</a> </p>
		<p>Speaker: <a onclick="speakerChange('hero')">Hero</a> <a onclick="speakerChange('partner')">Partner</a> <a onclick="speakerChange('icon')">Icon</a> <a onclick="speakerChange('')">None</a></p>
		<p>Welcome to the Explorerscript Boundary Test! The idea of the site is to test if lines of text written in ExplorerScript fits in a the game's text box.<br>
			All characters should have the right size, but let me know if I messed up any symbol! The textbox is multi-line so you can check as many lines as you want.<br>
			These special symbols are supported, with some modifications:
		   <ul class="social-media">
			<li>\n - New Line</li>
			<li>\' - '</li>
			<li>\" - "</li>
			<li>[hero] [partner] [CS:X] - A name can only be 60px long, so this displays "wcwcwcwcw" that should be the max allowed size for a name</li>
		</ul>
		Everything else in brackets gets ignored. If I missed some useful and common tag of symbol, or you want some other feature implemented,
		or just want to correct me on my grammar (please do), let me know, I'm DasK on <a href="https://discord.gg/4e3X36f">SkyTemple's Discord</a>!<br>
		</p>
		<p>
		Check the sourcecode <a href="https://github.com/theDasK/TextTest">here</a>. <a href="https://www.dafont.com/wonder-mail.font">Wonder Mail</a> font by <a href="https://www.reddit.com/user/ShinxHijinx">ShinxHijinx</a>
		</p>
	</div>


	<script>

		function drawBox(nlines){

			canvas.height = 44*scale;
			output.height = 34*scale+20;
			context.clearRect(0, 0, canvas.width, canvas.height);

			if (nlines < 3) {
				canvas.height = 44*scale;
				context.drawImage(boxtop,0,0,240*scale,9*scale);
				context.drawImage(boxmid,0,9*scale,240*scale,26*scale);
				context.drawImage(boxbot,0,35*scale,240*scale,9*scale);
			} else {
				canvas.height = (18+13*nlines)*scale;
				context.drawImage(boxtop,0,0*scale,240*scale,9*scale);
				context.drawImage(boxmid,0,9*scale,240*scale,26*nlines*scale);
				context.drawImage(boxbot,0,(9+13*nlines)*scale,240*scale,9*scale);
			}
		}

		function inputChange(){

			let tin = speaker + input.value;

			let tout = tin.replaceAll('\\p', '<img src="assets/pmoney.png" class="icon icon-pmoney">')
			.replaceAll('[hero]', '<em class="hero">HITMONCHAN</em>').replaceAll('[partner]', '<em class="partner">MARSHADOW</em>')
			.replaceAll('[CS:X]', '<em class="team">wcwcwcwcw</em>').replaceAll('\\n', '<br>').replaceAll('\n', '<br>').replaceAll("\\'", "'")
			.replaceAll('\\"', '"').replaceAll('\\\\', '\\').replaceAll(/\[[^\]]*]/g,"")
			.replaceAll('\\b', '<img src="assets/iconbubble.png" class="icon icon-bubble">');
			
			output.innerHTML = tout;

			let param = [];
			param = tout.split("<br>");
			param = param.length;

			drawBox(param);
		}

		function scaleChange(newScale){

			scale = newScale;
			output.style.top = 10 + 7 * scale + "px";
			output.style.paddingLeft = 10 + 13 * newScale + "px";
			output.style.fontSize = 100 * newScale + "%";
			output.style.lineHeight = 13 * newScale + "px";

			box.height = 52 * scale;
			box.width = 240 * scale;
			inputChange();
		}

		function speakerChange(newSpeaker){

			if (!newSpeaker){
				speaker = "";
			} else if (newSpeaker == "icon") {
				speaker = '<img src="assets/iconbubble.png" class="bubble">: ';
			} else {
				speaker = "[" + newSpeaker + "]: ";
			}

			inputChange();
		}

		function load(){

			boxtop.src = 'assets/boxtop.png';
			boxmid.src = 'assets/boxmid.png';
			boxbot.src = 'assets/boxbot.png';

			if (!text) text = '.\\b: Hey, write something here!.';
			input.value = text.substr(1,text.length-2)
			setTimeout(inputChange,300);
			setTimeout(inputChange,2000);
		}

		function findGetParameter(parameterName) {

		let result = null, tmp = [];
		location.search.substr(1).split("&").forEach(function (item) {
			tmp = item.split("=");
			if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
		});
		return result;
		}

		//WS stuff

		let text = findGetParameter("text");
		let scale = findGetParameter("scale");
		let wsOn = findGetParameter("ws");
		let wsServer = findGetParameter("wsServer");

		let speaker = "";

		let input = document.getElementById('input');
		let output = document.getElementById('output');
		let canvas = document.getElementById('box');
		let context = canvas.getContext('2d');
		context.imageSmoothingEnabled = false;
		context.mozImageSmoothingEnabled = false;
		context.webkitImageSmoothingEnabled = false;
		let boxtop = new Image();
		let boxmid = new Image();
		let boxbot = new Image();

		if (!scale) scale = 2;
		scaleChange(scale);

		if (wsOn){

			if(!wsServer) wsServer="ws://localhost:45546";
			
			console.log("WS Server: " + wsServer);

			ws = new WebSocket(wsServer);

			ws.addEventListener("open", ()=> {
				console.log("Conected!");
			});

			ws.addEventListener("message", data => {

				console.log(data);
				let event = JSON.parse(data.data).event;
				if (event == "debugger_selected_string_changed"){
					console.log(JSON.parse(data.data).args);
					input.value = JSON.parse(data.data).args;
					inputChange();
				} 
			});
		}

		load();
	</script>
</body>
</html>